---
- name: "[ {{ test_identifier }} ] - Rescue/Debug"
  block:
    - name: "[ {{ test_identifier }} - Rescue/Debug ] Run MustGather to collect Skupper details"
      command: "oc adm must-gather --since={{ mg_last_minutes }} --dest-dir={{ mg_artifact_dest }}/{{ test_name }} --image={{ mg_image }}:{{ mg_tag }}"
      register: must_gather_output
      delegate_to: localhost

    - name: "[ {{ test_identifier }} - Rescue/Debug ] Check if the MustGather details were created"
      ansible.builtin.find:
        paths: "{{ mg_artifact_dest }}/{{ test_name }}"
        file_type: directory
        use_regex: yes
        patterns: "{{ mg_artifact_pattern }}"
      register: mg_artifacts

    - name: "[ {{ test_identifier }} - Rescue/Debug ] Compact the MustGather artifacts"
      community.general.archive:
        path: "{{ item.path }}"
        dest: "{{ mg_artifact_dest }}/{{ test_name }}/skupper-must-gather-details.tar.gz"
        format: gz
      loop: "{{ mg_artifacts.files }}"
      when:
        - mg_artifacts.files is defined
        - mg_artifacts.files | length > 0

    - name: "[ {{ test_identifier }} - Rescue/Debug ] Force a fail, otherwise it would be set as rescued"
      ansible.builtin.fail:
        msg: "A test step has failed. Skupper and cluster details were saved in the artifacts area"
