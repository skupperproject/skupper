---
# roles/teardown_test/tasks/main.yml
- name: Deleting test namespace by label
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: absent
    kind: Namespace
    label_selectors: "e2e.id={{ teardown_test_namespace_label }}"
  register: namespace

- name: Waiting for namespace deletion
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    kind: Namespace
    label_selectors: "e2e.id={{ teardown_test_namespace_label }}"
  register: namespace_info
  until: namespace_info.resources | length == 0
  retries: 20
  delay: 2

- name: Deleting test temporary directory
  ansible.builtin.file:
    path: "{{ teardown_test_temp_dir_path }}"
    state: absent

- name: Display deleted resources
  ansible.builtin.debug:
    msg: |
      Cleanup Summary:
      - Namespace: {{ namespace.resources | map(attribute='metadata.name') | list }}
      - Temporary Directory: {{ teardown_test_temp_dir_path }}
  when: namespace_info.resources | length > 0
